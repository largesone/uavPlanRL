# 实现计划

## 第一阶段：【环境层】升级状态与奖励，提供尺度不变、鲁棒的观测

- [x] 1. 实现双模式、结构化的"图观测"系统




  - 重构UAVTaskEnv的__init__方法，增加obs_mode参数支持"flat"和"graph"模式
  - 当obs_mode为"flat"时维持现有扁平向量观测空间，确保FCN向后兼容性
  - 当obs_mode为"graph"时定义gym.spaces.Dict观测空间，支持可变数量实体
  - 实现动态观测空间创建的工厂模式
  - _需求: 1.1, 1.2, 1.3, 1.4_

- [x] 2. 实现尺度不变的图模式状态输出





  - 重构UAVTaskEnv._get_state方法，支持图模式状态字典输出
  - 实现uav_features和target_features，仅包含归一化的实体自身属性（如res/max_res）
  - 实现relative_positions键，存储归一化相对位置向量(pos_j - pos_i) / MAP_SIZE
  - 实现distances键，存储无人机与目标间的归一化距离
  - 实现masks键，包含uav_mask和target_mask用于标识有效实体
  - _需求: 2.1, 2.2, 2.3, 2.4_
-

- [x] 3. 实现鲁棒的输入掩码机制





  - 在uav_features中增加is_alive位（0/1），标识无人机通信/感知状态
  - 在target_features中增加is_visible位（0/1），标识目标可见性状态
  - 实现掩码位与masks的结合使用，为TransformerGNN提供失效节点屏蔽能力
  - 编写单元测试验证部分可观测情况下的状态生成正确性
  - _需求: 3.1, 3.2, 3.3, 3.4_

- [x] 4. 实现Per-Agent奖励归一化






  - 修改UAVTaskEnv._calculate_reward方法，识别与无人机数量相关的奖励项
  - 对拥堵惩罚等数值会随无人机数量N增长的奖励项，除以当前有效无人机数量N_active
  - 实现奖励组件跟踪，记录归一化前后的奖励值用于调试和监控
  - 编写测试用例验证不同无人机数量下的奖励一致性
  - _需求: 4.1, 4.2, 4.3, 4.4_

## 第二阶段：【网络层】构建高效、鲁棒的TransformerGNN

- [x] 5. 创建TransformerGNN基础架构






  - 默认输出中文
  - 请使用MCP文件工具完成文件创建、编辑、删除等任务
  - 创建新的TransformerGNN类，继承Ray RLlib的TorchModelV2
  - 实现标准的RLlib网络接口：__init__, forward, value_function方法
  - 设计实体编码器架构，分别处理UAV和目标特征
  - 实现图模式输入的解析和预处理逻辑
- [x] 6. 引入相对位置编码机制












- [ ] 6. 引入相对位置编码机制







- [ ] 6. 引入相对位置编码机制

  - 默认输出中文
  - 请使用MCP文件工具完成文件创建、编辑、删除等任务
  - 实现PositionalEncoder模块，将relative_positions通过小型MLP生成位置嵌入
  - 在TransformerGNN.forward方法中，将位置嵌入加到对应的无人机-目标对特征嵌入上
  - 确保位置编码能够解决排列不变性被破坏的问题
  - 编写单元测试验证位置编码的正确性和有效性
  - _需求: 5.1_



- [x] 7. 实现局部注意力机制




  - 默认输出中文
  - 请使用MCP文件工具完成文件创建、编辑、删除等任务
  - 实现LocalAttention模块，基于distances张量进行k-近邻选择
  - 为每架无人机动态选择k个最近目标作为注意力计算上下文
  - 解决维度爆炸与显存OOM问题，支持大规模场景
  - 集成xformers库的分块Flash Attention（可选优化）
  - _需求: 5.2_
-

- [x] 8. 实现自适应k值与训练期随机化



  - 默认输出中文
  - 请使用MCP文件工具完成文件创建、编辑、删除等任务
  - 实现自适应k值计算：k = min(max(4, ceil(N / 4)), 16)
  - 在训练期间对k值进行随机抖动（k +/- 2），增强模型鲁棒性
  - 在推理期间使用确定性k值，确保结果可复现
  - 编写测试验证不同场景规模下k值的合理性
  - _需求: 5.3_
-

- [x] 9. 使用参数空间噪声进行探索





  - 默认输出中文
  - 请使用MCP文件工具完成文件创建、编辑、删除等任务
  - 实现NoisyLinear层，替换TransformerGNN内部所有nn.Linear层
  - 在forward方法中实现确定性推理开关，根据self.training状态控制噪声
  - 确保在eval()模式时关闭噪声，保证推理结果可复现性
  - 集成到Ray RLlib的TorchModelV2框架中，正确处理探索策略
  - _需求: 6.1, 6.2, 6.3, 6.4_

## 第三阶段：【训练策略层】实施课程学习与高级RLlib配置

- [x] 10. 创建课程学习训练协调器






- [ ] 10. 创建课程学习训练协调器



  - 默认输出中文
  - 请使用MCP文件工具完成文件创建、编辑、删除等任务
  - 创建run_curriculum_training.py脚本作为最高级别训练协调器
  - 设计CurriculumTrainer类，管理多阶段训练流程
  - 实现训练阶段配置管理，支持不同复杂度场景的渐进式训练
  - 集成Ray RLlib的训练接口，确保与现有训练流程兼容
  - _需求: 7.1_


- [x] 11. 设计课程阶段与回退门限机制












  - 默认输出中文
  - 请使用MCP文件工具完成文件创建、编辑、删除等任务
  - 定义课程列表：从少实体场景（2-3 UAV, 1-2目标）到多实体场景（15+ UAV, 10+目标）
  - 实现回退门限机制，监控Norma
lized Completion Score等关键性能指标
  - 当连续3个评估周期性能低于上阶段最终性能60%时，自动回退到上一阶段


  - 实现学习率调整和模型状态恢复机制
  - _需求: 7.2, 7.3_



- [ ] 12. 实现混合经验回放机制







  - 默认输出中文
  - 若写入文件失败，只创建文件，不用直接写入文件，输出文件名称、内容、存储位置即可。
  - 利用Ray RLlib的自定义Replay Buffer API，实现MixedExperienceReplay类


  - 在课程学习第二阶段及以后，采样批次包含70%当前阶段经验和30%旧阶段经验
  - 实现经验池管理，防止灾难性遗忘
  - 编写测试验证混合采样的正确性和有效性
  - _需求: 7.4, 10.1_

- [x] 13. 解决分布式训练的数据一致性









  - 实现异常默认和重试机制，确保分布式训练稳定



  - 请使用MCP文件工具完成文件创建、编辑、删除等任务
  - 在RLlib的RolloutWorker中，对图数据字典的张量调用.cpu().share_memory_()
  - 在RLlib的Learner中，配置数据加载器使用pin_memory=True
  - 处理GNN稀疏张量跨进程传输的兼容性问题
  - 实现异常处理和重试机制，确保分布式训练稳定性
  - _需求: 8.1, 8.2, 8.3, 8.4_



- [x] 14. 实现训练数据保存与TensorBoard集成




  - 默认输出中文
  - 请使用MCP文件工具完成文件创建、编辑、删除等任务
  - 集成TensorBoard支持，记录课程学习各阶段的训练指标


  - 实现训练数据自动保存机制，包括模型检查点、训练历史、评估结果
  - 记录尺度不变指标到TensorBoard：Per-Agent Reward、Normalized Completion Score、Efficiency Metric
  - 实现课程学习进度可视化，包括阶段切换、回退事件、性能趋势
  - 保存每个训练阶段的最佳模型和配置参数

  - _需求: 7.1, 9.1, 9.2, 9.3_



## 第四阶段：【评估层】引入尺度不变的评价指标

- [ ] 15. 升级日志与评估系统

  - 在Ray RLlib的CustomCallbacks中增加尺度不变指标计算
  - 实现Per-Agent Reward计算：total_reward / N_active
  - 实现Normalized Completion Score计算：satisfied_targets_rate * (1 - average_congestion_metric)
  - 实现Efficiency Metric计算：total_completed_targets / total_flight_distance
  - 集成到TensorBoard日志系统，支持实时监控和历史回顾
  - _需求: 9.1, 9.2, 9.3_

- [ ] 16. 生成尺度不变的对比图表
  - 修改可视化模块，以尺度不变指标作为主要Y轴
  - 实现多场景规模的性能对比可视化
  - 生成零样本迁移能力的评估报告
  - 创建训练过程监控仪表板，实时显示关键指标
  - 实现TensorBoard自定义图表，展示课程学习进度和迁移性能

  - _需求: 9.4_

- [x] 17. 实现方案输出格式兼容性






  - 确保TransformerGNN的get_task_assignments方法与现有RL算法输出格式一致
  - 实现方案转换接口，将图模式决策结果转换为标准的任务分配格式
  - 保持与现有evaluate_plan函数的兼容性，支持统一的方案评估
  - 实现训练完成后的方案信息输出，包括分配结果、性能指标、迁移能力评估
  - 确保输出格式与main.py中的run_scenario流程完全兼容
  - _需求: 10.4_

## 集成与测试任务



- [ 验证方案输出格式的一致性和兼容性


  - 确保现有FCN架构和main.py的基础run_scenario流程独立运行
  - 实现配置开关，允许用户选择使用传统方法或新的TransformerGNN方法
  - 编写兼容性测试，验证现有功能不受影响
  - 更新文档，说明新旧系统的使用方法和差异
  - 验证方案输出和评估流程式完整和
容性
  - _需求: 10.4_



- [ ] 19. 端到端系统集成测试

  - 实现完整的课程学习训练流程测试
  - 验证零样本迁移能力：从小规模训练场景到大规模测试场景
  - 测试分布式训练的稳定性和性能
  - 验证尺度不变指标的正确性和一致性
  - 测试TensorBoard日志记录和可视化功能的完整性
  - 验证方案输出和评估流程的完整性

  - _需求: 所有需求的综合验证_



- [x] 20. 性能优化与监控



  - 实现内存使用监控，优化大规模场景下的内存占用
  - 性能基准测试，与现有方法进行训练速度和推理延迟对比
  - 实现训练过程可视化，包括课程学习进度和回退事件
  - 编写性能调优指南和最佳实践文档
  - 创建TensorBoard插件，支持自定义指标和图表展示
  - 实现方案质量对比分析，展示零样本迁移的性能提升
  - _需求: 设计文档中的性能要求_